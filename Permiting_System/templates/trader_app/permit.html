{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="{% static 'trader_app/permit.css' %}">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/awesomplete/1.1.5/awesomplete.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/awesomplete/1.1.5/awesomplete.min.js"></script>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
<title>Permit</title>
</head>
<body>
    <style>
        #map-container {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            height: 100vh;
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 1rem;
        }
        .map-wrapper {
            width: 100%;
            max-width: 1200px;
            height: 100%;
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: relative;
        }
        #map {
            width: 100%;
            height: 100%;
        }
        .search-container {
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            display: flex;
            justify-content: center;
            z-index: 1000;
        }
        .search-bar {
            width: 100%;
            max-width: 400px;
            display: flex;
            align-items: center;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            padding: 0.5rem;
        }
        .search-bar input {
            width: 100%;
            border: none;
            outline: none;
            padding: 0.5rem;
            font-size: 1rem;
        }
        .search-bar button {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.2rem;
            color: #1e90ff;
        }
        .awesomplete {
            width: 100%;
        }
        .awesomplete ul {
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-top: 0.5rem;
            padding: 0.5rem 0;
            list-style: none;
            max-height: 200px;
            overflow-y: auto;
        }
        .awesomplete li {
            padding: 0.5rem 1rem;
            cursor: pointer;
        }
        .awesomplete li:hover, .awesomplete li[aria-selected="true"] {
            background-color: #1e90ff;
            color: white;
        }
        @media (max-width: 768px) {
            #map-container {
                padding: 0.5rem;
            }
            .map-wrapper {
                height: 80vh;
            }
            .search-bar {
                max-width: 300px;
            }
        }
    </style>
    <header>
        <div class="logo"><img src="{% static 'index_app/ministry-of-agriculture-animal-industry-and-fisheries_0.png' %}" class="image"></div>
        <nav>
            <ul class="nav-links">
                <li><a href="{% url 'trader:trader' %}">Home</a></li>
                <li><a href="{% url 'trader:trader_profile' %}">Profile</a></li>
                <li><a href="{% url 'auth:logout' %}">Logout</a></li>
            </ul>
        </nav>
    </header>
    
    <main>
        <div class="download-btn">
            <button id="download-btn">Download Permit</button>
        </div>
        
        <div id="permit" class="container">
            <div class="qr-code">
                <div class="permit-title">
                    <img src="{% static 'ministrylogo_0.webp' %}" alt="Profile Picture">
                    <div class="title">
                        <h1>MAAIF MOVEMENT PERMIT</h1>
                        <h1>(-District to District-)</h1>
                    </div>
                </div>
                <img src="data:image/png;base64,{{ permit_base64_image_data }}" alt="QR Code" class="img-fluid">
            </div>
        
            <div class="divider1"></div>
            <div class="divider2"></div>
            <div class="divider3"></div>
        
            <div class="permit-content-divider">
                <h1>MOVEMENT PERMIT</h1>
            </div>
        
            <div class="person-info">
                <div class="profile-picture">
                    <img src="{{permit.trader.profile_picture.url}}" alt="Profile Picture">
                </div>
            
                <div class="person-details">
                    <div class="person-details-labels">
                        <h4>No.</h4>
                        <h4>County of:</h4>
                        <h4>Surname:</h4>
                        <h4>Given Name:</h4>
                    </div>
                    <div class="person-details-inputs">
                        <h4>{{ permit.id }}</h4>
                        <h4>{{ permit.trader.county }}</h4>
                        <h4>{{ permit.trader.first_name }}</h4>
                        <h4>{{ permit.trader.last_name }}</h4>
                    </div>
                </div>
            </div>
            
            <div class="permit-info">
                <div class="permit-info-labels">
                    <h1>a) From:</h1>
                    <h1>b) To:</h1>
                    <h1>c) Quantity:</h1>
                    <h1>d) For the purpose of:</h1>
                </div>
        
                <div class="permit-info-inputs">
                    <h1>{{ permit.source }}</h1>
                    <h1>{{ permit.destination }}</h1>
                    <h1>{{ total_animals }}</h1>
                    <h1>{{ permit.purpose }}</h1>
                </div>
            </div>
        
            <div class="inspector-date-info">
                <div class="inspector-info">
                    <h4>{{ permit.user.first_name }} {{ permit.user.last_name }}</h4>
                    <div class="line"></div>
                    <h4>Inspecting Office</h4>
                </div>
                <div class="date-info">
                    <h4>{{ permit.date_of_expiry }}</h4>
                    <div class="line"></div>
                    <h4>Date</h4>
                </div>
            </div>
            <div class="footer">
                <h2>Conditions</h2>
                <p>This permit is issued subject to observance of and compliance with the particular furnished and set out in (a) to (f) of this permit.</p>
            </div>
        </div>
        
        {% for animal_info, animal_base64_image_data in zipped_animal_info %}
            <div class="container-2">
                <div class="image">
                    <img src="data:image/png;base64,{{ animal_base64_image_data }}" alt="QR Code" class="img-fluid">
                </div>
                <div class="animal-info">
                    <h1><strong>Animal Type:</strong> {{ animal_info.animal.type }}</h1>
                    <h1><strong>Quantity:</strong> {{ animal_info.quantity }} / {{ total_animals }}</h1>
                    <h1><strong>Sex:</strong> {{ animal_info.sex }}</h1>
                    <h1><strong>Color:</strong> {{ animal_info.color }}</h1>
                    <h1><strong>License ID:</strong> {{ animal_info.trader.license_id }}</h1>
                    <h1><strong>Permit ID:</strong> {{ animal_info.permit.id }}</h1>
                </div>
                <div class="image">
                    <img src="{{ animal_info.animal.animal_img.url }}" alt="Animal Image" class="img-fluid"> 
                </div>
            </div>
        {% endfor %}

        <div id="map-container">
            <div class="map-wrapper">
                <div class="search-container">
                    <div class="search-bar">
                        <input type="text" id="search-input" class="awesomplete" placeholder="Search for places..." />
                        <button id="search-btn"><i class="fas fa-search"></i></button>
                    </div>
                </div>
                <div id="map"></div>
            </div>
        </div>
    </main>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.js"></script>
    <script>
        window.onload = function () {
            document.getElementById("download-btn")
                .addEventListener("click", () => {
                    const permit = this.document.getElementById("permit");
                    console.log(permit);
                    console.log(window);
                    var opt = {
                        margin: 0.1,
                        filename: '{{ permit.id }} permit.pdf',
                        image: { type: 'jpeg', quality: 0.98 },
                        html2canvas: { scale: 2 },
                        jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
                    };
                    html2pdf().from(permit).set(opt).save();
                })
        }
        
        const sourceCoordinates = {{ source_coordinates|safe }};
        const destinationCoordinates = {{ destination_coordinates|safe }};
        let permitStatus = "{{ permit_status }}";
    
        console.log("Permit status:", permitStatus);
    
        const map = L.map('map').setView([sourceCoordinates.latitude, sourceCoordinates.longitude], 7);
    
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    
        let initialRouteColor = 'blue';
    
        if (permitStatus === "In Transit") {
            initialRouteColor = 'yellow';
        } else if (permitStatus === "Expired") {
            initialRouteColor = 'red';
        }
    
        if (!navigator.geolocation) {
            console.log("Your browser doesn't support geolocation feature!");
        } else {
            setInterval(() => {
                if (permitStatus === "In Transit") {
                    navigator.geolocation.getCurrentPosition(getPosition);
                }
            }, 5000);
        }
    
        function getPosition(position) {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;
    
            updateTraderPosition(lat, lon);
    
            L.circle([lat, lon], {
                color: 'blue',
                fillColor: '#30f',
                fillOpacity: 0.5,
                radius: 500
            }).addTo(map);
        }
    
        function updateTraderPosition(latitude, longitude) {
            fetch("{% url 'trader:update_position' permit.id %}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": "{{ csrf_token }}"
                },
                body: JSON.stringify({
                    latitude: latitude,
                    longitude: longitude
                })
            })
            .then(response => response.json())
            .then(data => {
                console.log('Position updated:', data);
            })
            .catch((error) => {
                console.error('Error:', error);
            });
        }
    
        const control = L.Routing.control({
            waypoints: [
                L.latLng(sourceCoordinates.latitude, sourceCoordinates.longitude),
                L.latLng(destinationCoordinates.latitude, destinationCoordinates.longitude)
            ],
            routeWhileDragging: true,
            lineOptions: {
                styles: [{color: initialRouteColor, opacity: 0.7, weight: 4}]
            }
        }).addTo(map);

        var truckIcon = L.icon({
			iconUrl: "{% static 'trader_app/truck.jpeg' %}",
			iconSize: [40, 40]
		})
    
        let marker = L.marker([sourceCoordinates.latitude, sourceCoordinates.longitude], { icon: truckIcon }).addTo(map);
    
        if (permitStatus === "In Transit") {
            control.on('routesfound', function (e) {
                const route = e.routes[0].coordinates;
                let index = 0;
    
                function moveMarker() {
                    if (index < route.length) {
                        marker.setLatLng([route[index].lat, route[index].lng]);
                        index++;
                        setTimeout(moveMarker, 10);
                    } else {
                        fetch("{% url 'trader:update_permit_status' permit.id %}", { method: 'POST' })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    marker.setLatLng([destinationCoordinates.latitude, destinationCoordinates.longitude]);
                                    alert('Permit status updated to Expired');
                                    permitStatus = "Expired";
                                } else {
                                    alert('Failed to update permit status');
                                }
                            });
                    }
                }
                moveMarker();
            });
        }

        
        // Geocoding function to search for places
        function searchPlace(query) {
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${query}`)
                .then(response => response.json())
                .then(data => {
                    if (data.length > 0) {
                        const place = data[0];
                        const lat = place.lat;
                        const lon = place.lon;

                        // Set the map view to the searched place
                        map.setView(new L.LatLng(lat, lon), 13);

                        // Add a marker for the searched place
                        L.marker([lat, lon]).addTo(map)
                            .bindPopup(place.display_name)
                            .openPopup();
                    } else {
                        alert('Place not found.');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error searching for place.');
                });
        }

        // Autocomplete function to fetch suggestions
        function fetchSuggestions(query, callback) {
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${query}`)
                .then(response => response.json())
                .then(data => {
                    const suggestions = data.map(place => place.display_name);
                    callback(suggestions);
                })
                .catch(error => {
                    console.error('Error:', error);
                    callback([]);
                });
        }

        const awesomplete = new Awesomplete(document.getElementById("search-input"), {
            minChars: 3,
            maxItems: 10
        });

        document.getElementById("search-input").addEventListener("input", function() {
            const query = this.value;
            if (query.length >= 3) {
                fetchSuggestions(query, function(suggestions) {
                    awesomplete.list = suggestions;
                });
            }
        });

        // Event listener for search button
        document.getElementById('search-btn').addEventListener('click', () => {
            const query = document.getElementById('search-input').value;
            if (query) {
                searchPlace(query);
            }
        });

        // Event listener for enter key in search input
        document.getElementById('search-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const query = e.target.value;
                if (query) {
                    searchPlace(query);
                }
            }
        });

        // Event listener for selecting an autocomplete suggestion
        document.getElementById('search-input').addEventListener('awesomplete-selectcomplete', function() {
            const query = this.value;
            searchPlace(query);
        });
    </script>
</body>
</html>